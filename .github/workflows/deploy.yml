name: Deploy and Notify with Approval

on:
  push:
    branches:
      - master  # Trigger deployment on push to master

jobs:
  deploy:
    runs-on: ubuntu-latest  # GitHub-hosted runner
    strategy:
      matrix:
        environment: ["Dev", "Test", "Staging", "Prod"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Prepare deploy.sh
        run: chmod +x deploy.sh

      - name: Deploy to ${{ matrix.environment }}
        run: ./deploy.sh ${{ matrix.environment }} 1.0.0

  notify:
    needs: deploy
    runs-on: ubuntu-latest  # GitHub-hosted runner
    steps:
      - name: Send Slack Notification for Approval
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "text": "üöÄ *Deployment Completed for ${{ github.repository }}* \nüîç *Environment:* ${{ matrix.environment }}\n‚úÖ *Status:* Success\nüîó *Run Details:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>\n\n‚ö†Ô∏è *Action Required:* Please approve the next step in GitHub Actions before proceeding."
          }' ${{ secrets.SLACK_WEBHOOK_URL }}

  approval:
    needs: notify
    runs-on: ubuntu-latest  # GitHub-hosted runner
    environment: production  # Ensures manual approval is required
    steps:
      - name: Approval Received
        run: echo "Manual approval granted. Proceeding with deployment finalization."

      - name: Execute Post-Approval Steps
        run: |
          echo "Executing final deployment steps after approval..."
          ./finalize_deployment.sh

      - name: Send Slack Notification - Database Schema Deployed
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "text": "‚úÖ *Database schema is deployed successfully for ${{ github.repository }}* \n\nüéØ *Environment:* ${{ matrix.environment }}\nüîó *Run Details:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"
          }' ${{ secrets.SLACK_WEBHOOK_URL }}
